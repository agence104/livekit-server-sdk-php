name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  lint:
    name: PHP ${{ matrix.php }} - ${{ matrix.stability }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']
        stability: [prefer-lowest, prefer-stable]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2, parallel-lint
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction --no-progress --no-suggest

      - name: Lint PHP files
        run: parallel-lint --show-deprecated --exclude src/proto src/ tests/

  tests:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction --no-progress --no-suggest

      - name: Start RTMP test server
        run: |
          docker run -d --name rtmp-server -p 1935:1935 tiangolo/nginx-rtmp
          sleep 3

      - name: Install bore (TCP tunnel)
        run: |
          curl -L https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-unknown-linux-musl.tar.gz -o bore.tar.gz
          tar -xzf bore.tar.gz
          chmod +x bore
          sudo mv bore /usr/local/bin/

      - name: Start TCP tunnel for RTMP
        run: |
          bore local 1935 --to bore.pub > /tmp/bore.log 2>&1 &
          BORE_PID=$!
          sleep 5
          # Extract public URL from bore output (format: Listening on bore.pub:port)
          BORE_PORT=$(grep -oE 'bore\.pub:[0-9]+' /tmp/bore.log | head -1 | cut -d: -f2)
          if [ -z "$BORE_PORT" ]; then
            # Try alternative format: "Listening on bore.pub:12345"
            BORE_PORT=$(grep -oE 'Listening on bore\.pub:[0-9]+' /tmp/bore.log | head -1 | cut -d: -f2)
          fi
          if [ -z "$BORE_PORT" ]; then
            echo "Failed to extract bore tunnel port. Log:"
            cat /tmp/bore.log
            exit 1
          fi
          BORE_RTMP="rtmp://bore.pub:$BORE_PORT"
          echo "RTMP_URL=$BORE_RTMP/live/test" >> $GITHUB_ENV
          echo "RTMP_URL2=$BORE_RTMP/live/test2" >> $GITHUB_ENV
          echo "Public RTMP URL: $BORE_RTMP"
          echo "Bore PID: $BORE_PID"
          cat /tmp/bore.log

      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.LIVEKIT_URL }}" ] || [ -z "${{ secrets.LIVEKIT_API_KEY }}" ] || [ -z "${{ secrets.LIVEKIT_API_SECRET }}" ]; then
            echo "::warning::LiveKit secrets not configured. Tests will be skipped."
            echo "Please set LIVEKIT_URL, LIVEKIT_API_KEY, and LIVEKIT_API_SECRET in repository secrets."
            exit 0
          fi

      - name: Run tests
        if: ${{ secrets.LIVEKIT_URL != '' && secrets.LIVEKIT_API_KEY != '' && secrets.LIVEKIT_API_SECRET != '' }}
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
          LIVEKIT_EGRESS_RTMP_URL: ${{ env.RTMP_URL || secrets.LIVEKIT_EGRESS_RTMP_URL }}
          LIVEKIT_EGRESS_RTMP_URL2: ${{ env.RTMP_URL2 || secrets.LIVEKIT_EGRESS_RTMP_URL2 }}
        run: vendor/bin/phpunit --configuration phpunit.xml
